<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sign Up (Step 2) - OptiLife</title>
    <link rel="stylesheet" href="usercss/signin_signup.css"> 
    <link href='https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css' rel='stylesheet'>
</head>
<body>

    <div class="container">
        <div class="form-box signup">
            <form id="signup-step2-form" novalidate>
                <h1>Welcome! Finish signing up to get started.</h1>

                <div class="input-box">
                    <input type="text" placeholder="First Name" id="firstname" required>
                    <i class='bx bxs-user-detail'></i>
                </div>

                <div class="input-box">
                    <input type="text" placeholder="Last Name" id="lastname" required>
                     <i class='bx bxs-user-detail'></i>
                </div>

                <div class="input-box">
                    <input type="text" placeholder="Suffix (Optional)" id="suffix">
                    <i class='bx bx-user-pin'></i>
                </div>

                <div class="input-box">
                    <label for="date" class="date-label">Birth Date:</label>
                    <input type="date" id="date" min="1900-01-01" max="2025-01-01" required> 
                </div>

                <div class="input-box">
                    <input type="text" placeholder="Current Address" id="address" required>
                    <i class='bx bxs-map'></i>
                </div>

                 <div class="input-box"> <!-- Added Phone Number Input -->
                    <input type="tel" placeholder="Phone Number (e.g., 09xxxxxxxxx)" id="phoneNumber" required pattern="[0-9]{11}"> <!-- Basic pattern -->
                    <i class='bx bx-phone'></i>
                </div>


                <button type="submit" class="btn" id="complete-signup-btn">Complete Sign up</button>

                 <div class="navigation-link" style="margin-top: 15px;">
                     <a href="signup.html" style="color: #eee; font-size: 0.9em;">« Go Back to Step 1</a> <!-- Link back to step 1 -->
                 </div>

            </form>
        </div>
    </div>

    <!-- Modal definition -->
    <div id="Modal" class="modal">
        <div class="modal-content">
            <button id="closeModalButton" class="close-button">×</button>
            <p id="modalMessage">Sign up successful! Welcome!</p>
            <button id="okModalButton">OK</button>
        </div>
    </div>

    <script src="../assets/jquery-3.7.1.min.js"></script>
    <script>
        $(document).ready(function() {
            // --- Modal Elements ---
            const $modal = $("#Modal");
            const $closeButton = $("#closeModalButton");
            const $okButton = $("#okModalButton");
            const $modalMessage = $("#modalMessage");
            let currentOkAction = null; // To store function for OK button

            // --- Modal Functions ---
            const openModal = (message, isError = true, onOkAction = null) => {
                $modalMessage.text(message);
                $modalMessage.css("color", isError ? "red" : "black"); // Red for errors, black otherwise
                currentOkAction = onOkAction; // Store the action for the OK button
                $modal.addClass('show');
            };

            const closeModal = () => {
                $modal.removeClass('show');
                currentOkAction = null; // Clear the action when closing
            };

            // --- Modal Event Handlers ---
            $closeButton.on('click', closeModal);

            $okButton.on('click', function() {
                // Execute the stored action FIRST, then close
                if (typeof currentOkAction === 'function') {
                    currentOkAction(); // Execute the action (e.g., redirect)
                }
                closeModal(); // Always close after action or if no action
            });

            $modal.on('click', function(event) {
                if ($(event.target).is($modal)) { // Click on background
                    closeModal();
                }
            });

            $(document).on('keydown', function(event) {
                if (event.key === 'Escape' && $modal.hasClass('show')) {
                    closeModal();
                }
            });

            // --- Initial Check & Form Logic ---
            const savedEmail = sessionStorage.getItem('signupEmail');
            const savedPassword = sessionStorage.getItem('signupPassword');
            const savedUsername = sessionStorage.getItem('signupUsername'); // Get username if stored

            const redirectToStep1 = () => {
                window.location.href = 'signup-step1.html';
            };

            if (!savedEmail || !savedPassword) {
                // Use modal instead of alert, provide redirect action for OK button
                openModal("Please complete Step 1 of the signup first.", true, redirectToStep1);
                return; // Stop further execution
            }

            $("#signup-step2-form").on("submit", function(event) { // Use submit event on form
                event.preventDefault(); // Prevent default form submission

                // Get form values
                const firstName = $("#firstname").val().trim();
                const lastName = $("#lastname").val().trim();
                const suffix = $("#suffix").val().trim(); // Optional
                const birthDate = $("#date").val();
                const address = $("#address").val().trim();
                const phoneNumber = $("#phoneNumber").val().trim(); // Get phone number


                // Reset previous error styles
                $("#firstname, #lastname, #date, #address, #phoneNumber").css("border", "");

                // --- Validation Checks (using modal) ---
                if (!firstName) {
                    openModal("Please enter your First Name.");
                    $("#firstname").css("border", "1px solid red");
                    return; // Stop if invalid
                }
                if (!lastName) {
                    openModal("Please enter your Last Name.");
                    $("#lastname").css("border", "1px solid red");
                    return;
                }
                if (!birthDate) {
                    openModal("Please select your Birth Date.");
                    $("#date").css("border", "1px solid red");
                    return;
                }
                 // Basic phone number validation (e.g., 11 digits) - adjust regex as needed
                const phoneRegex = /^[0-9]{11}$/;
                 if (!phoneNumber) {
                    openModal("Please enter your Phone Number.");
                    $("#phoneNumber").css("border", "1px solid red");
                    return;
                } else if (!phoneRegex.test(phoneNumber)) {
                     openModal("Please enter a valid 11-digit Phone Number.");
                     $("#phoneNumber").css("border", "1px solid red");
                     return;
                 }
                if (!address) {
                    openModal("Please enter your Current Address.");
                    $("#address").css("border", "1px solid red");
                    return;
                }


                // --- If all Step 2 validations pass ---
                console.log("Step 2 validation passed. Preparing redirect.");

                // Hardcoded credentials for role check (replace with actual backend logic)
                const adminEmail = "admin@gmail.com";
                const adminPassword = "admin123";
                const ownerEmail = "gymOwner@gmail.com";
                const ownerPassword = "gymOwner123";
                const clientEmail = "user@gmail.com";
                const clientPassword = "user0123";

                let redirectUrl = "signin.html"; // Default redirect

                if (savedEmail === clientEmail && savedPassword === clientPassword) {
                    redirectUrl = "home.html";
                } else if (savedEmail === ownerEmail && savedPassword === ownerPassword) {
                    redirectUrl = "../GymOwner/gymOwner.html";
                } else if (savedEmail === adminEmail && savedPassword === adminPassword) {
                    redirectUrl = "../Admin/admindb.html";
                } else {
                     // For any other new signup, redirect to signin page
                     redirectUrl = "signin.html";
                     console.log("New user registration (not predefined role), redirecting to signin.");
                }

                // Function to perform the actual redirect and clear storage
                const completeSignupAndRedirect = () => {
                     console.log("Redirecting to:", redirectUrl);
                     // Clear sensitive signup data from session storage
                     sessionStorage.removeItem('signupEmail');
                     sessionStorage.removeItem('signupPassword');
                     sessionStorage.removeItem('signupUsername'); // Clear username too if stored
                     // Store non-sensitive info if needed AFTER login, not here
                     window.location.href = redirectUrl;
                };

                // Show success modal (not an error)
                // Provide the redirect function as the OK action
                openModal("Sign up complete! Welcome!", false, completeSignupAndRedirect);

                // Optionally, automatically redirect after a delay
                 setTimeout(completeSignupAndRedirect, 2000); // Redirect after 2 seconds

            });
        });
    </script>

</body>
</html>